version: 2.1
description: "Sonatype Nexus Platform Integration"

executors:
  default:
    description: "CircleCI image for OpenJDK"
    docker:
    - image: circleci/openjdk

commands:
  install:
    description: "Installs the nexus-platform-api and CLI script"
    parameters:
      groovy-version:
        type: string
        default: "2.5.3"
    steps:
    - run: |
        curl -L https://dl.bintray.com/groovy/maven/apache-groovy-binary-<<parameters.groovy-version>>.zip -o apache-groovy-binary.zip
        curl -L https://raw.githubusercontent.com/sonatype-nexus-community/circleci-nexus-orb/INT-1109_repository_groovy_wrapper/cli/src/main/groovy/NexusPublisher.groovy -o NexusPublisher.groovy
        unzip apache-groovy-binary.zip
        mv groovy-<< parameters.groovy-version>> groovy

  archive:
    description: "Archives artifacts to Nexus Repository Manager"
    parameters:
      username:
        type: string
        default: "admin"
      password:
        type: string
        default: "admin123"
      serverurl:
        type: string
        default: "http://localhost:8081/"
      filename:
        type: string
        default: "/tmp/workspace/test1-1.0-SNAPSHOT.jar"
      format:
        type: string
        default: "maven2"
      groupId:
        type: string
        default: "com.example"
      artifactId:
        type: string
        default: "myapp"
      version:
        type: string
        default: "1.0"
      extension:
        type: string
        default: "jar"
      repository:
        type: string
        default: "maven-releases"

    steps:
    - attach_workspace:
        at: /tmp/workspace
    - run: >
        groovy/bin/groovy NexusPublisher.groovy
        --username <<parameters.username>>
        --password <<parameters.password>>
        --serverurl <<parameters.serverurl>>
        --filename <<parameters.filename>>
        --format <<parameters.format>>
        -CgroupId=<<parameters.groupId>>
        -CartifactId=<<parameters.artifactId>>
        -Cversion=<<parameters.version>>
        -Aextension=<<parameters.extension>>
        --repository <<parameters.repository>>

jobs:
  nexusjob:
    executor: default
    steps:
    - install
    - archive
